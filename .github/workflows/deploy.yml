name: CI/CD Pipeline

# Trigger: Run ONLY when a Release is created
on:
  release:
    types: [created]

jobs:
  build-and-deploy:
    runs-on: self-hosted  # <--- This is the magic. It runs ON YOUR VM.

    steps:
    # 1. Get the latest code
    - name: Checkout code
      uses: actions/checkout@v3

    # 2. Log in to Docker Hub
    - name: Login to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    # 3. Build the Docker Image (Using the Release Tag, e.g., v1.1)
    - name: Build and Push Docker Image
      run: |
        IMAGE_NAME=abdullah153/todo-app
        TAG=${{ github.event.release.tag_name }}
        
        # KEY FIX: Point to the exact sub-folder
        docker build -t $IMAGE_NAME:$TAG ./project/task1/my-todo-app
        
        docker push $IMAGE_NAME:$TAG

    # 4. Deploy to Kubernetes
    - name: Update Kubernetes Deployment
      run: |
        TAG=${{ github.event.release.tag_name }}
        
        # Tell Kubernetes to change the image to the new version
        kubectl set image deployment/todo-app-deployment todo-app=abdullah153/todo-app:$TAG --record
        
        # Verify the rollout status
        kubectl rollout status deployment/todo-app-deployment
